# init.recovery.mt6879.rc
# Main recovery init for Motorola Edge 40 Neo (manaus) - MT6879
# CONFIGURADO PARA VENDOR_BOOT - NAO FICA NO RECOVERY TRADICIONAL

import /init.recovery.usb.rc
import /mtk-plpath-utils.rc

on early-init
    # Set up recovery environment
    export ANDROID_ROOT /system_root
    export ANDROID_DATA /data
    export EXTERNAL_STORAGE /sdcard
    
    # Create necessary directories
    mkdir /dev/block 0755 root root
    mkdir /dev/block/platform 0755 root root
    mkdir /dev/block/platform/bootdevice 0755 root root
    mkdir /dev/block/platform/bootdevice/by-name 0755 root root
    mkdir /dev/block/mapper 0755 root root
    mkdir /dev/block/by-name 0755 root root
    
    # Symlinks for compatibility
    symlink /dev/block/platform/bootdevice /dev/block/bootdevice
    symlink /dev/block/platform/bootdevice/by-name /dev/block/by-name
    
    # Create mount points
    mkdir /metadata 0771 root root
    mkdir /data 0771 root root
    mkdir /sdcard 0771 root root
    mkdir /external_sd 0771 root root
    mkdir /usb_otg 0771 root root
    mkdir /tmp 0775 root shell
    mkdir /system_root 0771 root root
    
    # Framebuffer permissions - CRITICAL FOR DISPLAY
    chown root root /dev/graphics/fb0
    chmod 0666 /dev/graphics/fb0
    
    # Backlight
    chown root root /sys/class/leds/lcd-backlight/brightness
    chmod 0666 /sys/class/leds/lcd-backlight/brightness
    chown root root /sys/class/backlight/panel0-backlight/brightness
    chmod 0666 /sys/class/backlight/panel0-backlight/brightness

on init
    # Device properties
    setprop ro.hardware mt6879
    setprop ro.hardware.platform mt6879
    setprop ro.board.platform mt6879
    setprop ro.product.board mt6879
    
    # Recovery
    setprop ro.build.product manaus
    setprop ro.product.device manaus
    setprop ro.product.name manaus
    
    # Debug
    setprop ro.debuggable 1
    setprop ro.secure 0
    setprop ro.adb.secure 0
    
    # TWRP
    setprop ro.twrp.boot true
    setprop ro.twrp.version 3.7.0_12
    
    # MediaTek
    setprop ro.mediatek.platform MT6879
    
    # Disable verified boot checks
    setprop ro.boot.verifiedbootstate orange
    setprop ro.boot.vbmeta.device_state unlocked
    
    # Dynamic partitions
    setprop ro.boot.dynamic_partitions true
    
    # USB
    setprop sys.usb.controller 11201000.usb0
    setprop sys.usb.configfs 1

on fs
    # Mount metadata first
    mount ext4 /dev/block/by-name/metadata /metadata rw nosuid nodev noatime
    
    # Create mapper directory if not exists
    mkdir /dev/block/mapper 0755 root root
    
    # Setup dynamic partitions
    exec u:r:recovery:s0 -- /system/bin/mtk_plpath_utils
    
    # Wait for mapper devices
    wait /dev/block/mapper/system 5
    wait /dev/block/mapper/vendor 5
    wait /dev/block/mapper/product 5
    
    # Try to mount data (may fail if encrypted - that's OK)
    mount f2fs /dev/block/by-name/userdata /data rw nosuid nodev noatime || \
    mount ext4 /dev/block/by-name/userdata /data rw nosuid nodev noatime || \
    echo "Data mount failed (expected if encrypted)"

on post-fs
    # Symlinks for dynamic partitions
    symlink /dev/block/mapper/system /dev/block/system
    symlink /dev/block/mapper/vendor /dev/block/vendor
    symlink /dev/block/mapper/product /dev/block/product
    symlink /dev/block/mapper/system_ext /dev/block/system_ext
    symlink /dev/block/mapper/vendor_dlkm /dev/block/vendor_dlkm
    
    # Start post recovery boot script
    exec u:r:recovery:s0 -- /sbin/postrecoveryboot.sh

on post-fs-data
    # Ensure data directories exist
    mkdir /data/media 0770 media_rw media_rw
    mkdir /data/media/0 0770 media_rw media_rw
    
    # Set up adb
    mkdir /data/adb 0700 root root

on boot
    # Start essential services
    start health-hal-2-1
    
    # Set USB to mtp,adb mode
    setprop sys.usb.config mtp,adb
    
    # Start ADB
    start adbd

# Service definitions
service health-hal-2-1 /system/bin/hw/android.hardware.health@2.1-service
    class hal
    user root
    group root
    seclabel u:r:recovery:s0

service mtk.plpath.utils.link /system/bin/mtk_plpath_utils
    class main
    user root
    group root system
    oneshot
    disabled
